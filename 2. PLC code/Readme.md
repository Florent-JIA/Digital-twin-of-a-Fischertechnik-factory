# PLC code of the SLD module
In this file, I will describe our work for the coding of the SLD module (and its correct functioning).

First of all, we had to list the different actions that we wanted our code to make :

- detect a new element at the entrance of the SLD module
- activate the conveyer belt
- detect the color of the element
- activate the correct ejector at the right time to make the element fall into its compartment

In order to fully understand the functioning of the SLD module we made a plan of it :
![SLD plan](https://github.com/Weizhe-JIA/2.Digital-twin-of-a-Fischertechnik-factory/blob/main/imgs/3.1%20plan%20of%20SLD.png)
Note : In order to have a landmark on the conveyer belt (to know where we are with an element), we do not use a clock. Indeed, if the motor had an issue we would not be able to correctly sort the element. That's why we use the pulse input, the pulse allows us to measure the distance the conveyer belt runs through the simulation (it turns and changes state when a certain distance is generated by the motor).

Now that we see what we are talking about and that we know what we want to do, we need to make a state graph with the different inputs and outputs involved in each part of the SLD module :
![work flow of the PLC code](https://github.com/Weizhe-JIA/2.Digital-twin-of-a-Fischertechnik-factory/blob/main/imgs/3.2%20State_diaram_ProCom__1_.png)
<br>We are now able to code the different parts / states of the SLD module and make them communicate. Our code for the functioning of the SLD module is available here : [Fonctionnement_SLD.ino](https://github.com/Weizhe-JIA/2.Digital-twin-of-a-Fischertechnik-factory/blob/main/2.%20PLC%20code/Fonctionnement_SLD.ino/)

Note : There is no need to define the pinmodes in comparison to many other Arduino projects since the IndustrialShield board understands which pin we are calling by itself. Moreover, you can either call a pin by its number ("66") or by its name ("I2.7").

Note : You need to let a delay between the activation / desactivation of the compressor and its last action. Else the valves of the ejectors might make strange things ðŸ˜„  .

Note : Do not forget to comment your code a lot so that the next team won't be lost (we did our best but you might need to add some comments if you fell so).

Note : The code we realised can only handle one element at a time. It is possible to make it able to handle several elements using lists and queues, however it implies great changes in Arduino, in Unity and in Node-red and we realised that quite late which is why we only cared about one element.

Note : Our code has been designed so that it can be integrated with other modules of the factory. Indeed, in the "Loop" method, we call the "sld" method which makes the SLD module works, you are then able to add other methods called by your modules'names so that the "Loop" method remains understandable.

# HTTP Web Server
All the explication are taken from the IndustrialShield tutorials that you can find [here](https://www.industrialshields.com/blog/arduino-industrial-1/post/arduino-web-server-tutorial-438/)

We used Arduino to create a simple web page. By utilizing the Ethernet Library and leveraging industrial automation and Arduino automation technologies, we can respond to an HTTP request using the Ethernet shield. When you open a browser and navigate to your Arduino-based PLC's IP address with Ethernet, the Arduino will provide sufficient HTML to display input values from all six analog pins on the browser.
![work flow of web server](https://github.com/Weizhe-JIA/2.Digital-twin-of-a-Fischertechnik-factory/blob/main/imgs/3.3%20WebServer.png)
<br>In the Arduino code (1) that we have uploaded to our PLCs, we can retrieve the status and value of each sensor that makes up our SLD module. In our case, everything is local, so the PC is directly connected to the model with an ethernet cable
![Web server wire](https://github.com/Weizhe-JIA/2.Digital-twin-of-a-Fischertechnik-factory/blob/main/imgs/3.4%20WebServerWire.png)
We have chosen to keep the same IP address as in the following tutorial. So we have

- IP address from laptop: 10.10.10.60
- IP address from M-Duino PLC: 10.10.10.30

Then, when the client or browser makes the request by HTTP, our PLC will serve the data and it can be seen in the same browser. In our case, the client will be the dashboard which will make a request to our web server

The code to set up the Web Server is in the SLD-Connected.ino file [here](https://github.com/Weizhe-JIA/2.Digital-twin-of-a-Fischertechnik-factory/blob/main/2.%20PLC%20code/SLD-Connected.ino/).
<br>![web server](https://github.com/Weizhe-JIA/2.Digital-twin-of-a-Fischertechnik-factory/blob/main/imgs/3.5%20WebServer.png)

# Dealing with production line issues
As explained in the use cases of the project (available in Ressources), some issues might occur in the SLD module (actually we listed 2 : the element does not come out of the furnace and the element is not delivered well with the piston).

In order to detect and mitigate these issues, we added some variables and methods to the code, now the factory reacts as follows :

- if the element does not reach the detector after the furnace, then the conveyer belt automatically stops after some pulses.
- if the element does not reach its color detector after being pushed by the piston then an alarm is raised.

In both cases a notification is displayed on the dashboard.

For the first issue, the element is hidden in Unity so that it doesn't bring false information.

Dealing with issues is important. Indeed, even your code will probably work 99,99% of the time it is fundamental to gather as much information as you can on a potential issue, either provoked by human beings or machines. This is part of the concept of digital twin.

# MQTT Failure
We first wanted to use MQTT as a communication tool. However, we failed to implement it and use it with our PLC and the associated parts of the factory (MQTT broker and raspberry pi). MQTT is a publish/subscribe system allowing us to send and receive information without refreshing a web page every 0.5 second.

You might use this technology in the future, if you do so you will need to change the Arduino code (but not that much since it follows a modular conception), the Unity scripts (again not much since it is just another module) and the Node-red code (again and again not much since there is a dedicated block replacing the HTTP one).

Moreover, we think that using MQTT will be easier for you if you come to use several PLCs.
